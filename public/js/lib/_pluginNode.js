application={},connection={};var printError=function(e){console.error(),console.error(e)};process.on("message",function(e){switch(e.type){case"import":importScript(e.url);break;case"importJailed":importScriptJailed(e.url);break;case"execute":execute(e.code);break;case"message":try{conn._messageHandler(e.data)}catch(t){printError(t.stack)}}});var isRemote=function(e){return e.substr(0,7).toLowerCase()=="http://"||e.substr(0,8).toLowerCase()=="https://"},importScript=function(e){var t=function(){process.send({type:"importSuccess",url:e})},n=function(){process.send({type:"importFailure",url:e})},r=function(r){executeNormal(r,e,t,n)};if(isRemote(e))loadRemote(e,r,n);else try{r(loadLocal(e))}catch(i){printError(i.stack),n()}},importScriptJailed=function(e){var t=function(){process.send({type:"importSuccess",url:e})},n=function(){process.send({type:"importFailure",url:e})},r=function(r){executeJailed(r,e,t,n)};if(isRemote(e))loadRemote(e,r,n);else try{r(loadLocal(e))}catch(i){printError(i.stack),n()}},execute=function(e){var t=function(){process.send({type:"executeSuccess"})},n=function(){process.send({type:"executeFailure"})};executeJailed(e,"DYNAMIC PLUGIN",t,n)},executeNormal=function(e,t,n,r){var i=null;try{require("vm").runInThisContext(e,t),n()}catch(s){printError(s.stack),r()}},executeJailed=function(e,t,n,r){var i=require("vm"),s={},o=["application","setTimeout","setInterval","clearTimeout","clearInterval"];for(var u=0;u<o.length;u++)s[o[u]]=global[o[u]];e='"use strict";\n'+e;try{i.runInNewContext(e,i.createContext(s),t),n()}catch(a){printError(a.stack),r()}},loadLocal=function(e){return require("fs").readFileSync(e).toString()},loadRemote=function(e,t,n){var r=function(r){if(r.statusCode!=200){var i="Failed to load "+e+"\n"+"HTTP responce status code: "+r.statusCode;printError(i),n()}else{var s="";r.on("end",function(){t(s)}),r.on("readable",function(){var e=r.read();s+=e.toString()})}};try{require("http").get(e,r).on("error",n)}catch(i){printError(i.stack),n()}},conn={disconnect:function(){process.exit()},send:function(e){process.send({type:"message",data:e})},onMessage:function(e){conn._messageHandler=e},_messageHandler:function(){},onDisconnect:function(){}};connection=conn;