var __jailed__path__;if(typeof window=="undefined")__jailed__path__=__dirname+"/";else{var scripts=document.getElementsByTagName("script");__jailed__path__=scripts[scripts.length-1].src.split("?")[0].split("/").slice(0,-1).join("/")+"/"}(function(e,t){typeof define=="function"&&define.amd?define(["exports"],t):typeof exports!="undefined"?t(exports):t(e.jailed={})})(this,function(e){var t=typeof window=="undefined",n=function(){this._emitted=!1,this._handlers=[]};n.prototype.emit=function(){if(!this._emitted){this._emitted=!0;for(var e=0;e<this._handlers.length;e++)this._handlers[e].call(null)}},n.prototype.whenEmitted=function(e){e=this._checkHandler(e),this._emitted?setTimeout(e,0):this._handlers.push(e)},n.prototype._checkHandler=function(e){var t=typeof e;if(t!="function"){var n="A function may only be subsribed to the event, "+t+" was provided instead";throw new Error(n)}return e};var r=function(){require("./_JailedSite.js")},i,s=function(){var e=function(e,t){var n=document.createElement("script");n.src=e;var r=function(){n.onload=null,n.onerror=null,n.onreadystatechange=null,n.parentNode.removeChild(n)},i=function(){r(),t()};n.onerror=r,n.onload=i,n.onreadystatechange=function(){var e=n.readyState;(e==="loaded"||e==="complete")&&i()},document.body.appendChild(n)};i=new n;var t=window.onload||function(){};window.onload=function(){t(),e(__jailed__path__+"_JailedSite.js",function(){i.emit()})}},o,u=function(){var e=require("child_process");o=function(){this._disconnected=!1,this._messageHandler=function(){},this._disconnectHandler=function(){},this._process=e.fork(__jailed__path__+"_pluginNode.js");var t=this;this._process.on("message",function(e){t._messageHandler(e)}),this._process.on("exit",function(e){t._disconnected=!0,t._disconnectHandler(e)})},o.prototype.whenInit=function(e){e()},o.prototype.send=function(e){this._disconnected||this._process.send(e)},o.prototype.onMessage=function(e){this._messageHandler=function(t){try{e(t)}catch(n){console.error(),console.error(n.stack)}}},o.prototype.onDisconnect=function(e){this._disconnectHandler=e},o.prototype.disconnect=function(){this._process.kill("SIGKILL"),this._disconnected=!0}},a=function(){var e=[' self.addEventListener("message", function(m){          ','     if (m.data.type == "initImport") {                 ',"         importScripts(m.data.url);                     ",'         self.postMessage({type: "initImportSuccess"}); ',"     }                                                  "," });                                                    "].join("\n"),t=window.URL.createObjectURL(new Blob([e]));o=function(){this._init=new n,this._worker=new Worker(t),this._messageHandler=function(){};var e=this;this._worker.addEventListener("message",function(t){t.data.type=="initImportSuccess"?i.whenEmitted(function(){e._init.emit()}):e._messageHandler(t.data)}),this._worker.postMessage({type:"initImport",url:__jailed__path__+"_pluginWeb.js"})},o.prototype.whenInit=function(e){this._init.whenEmitted(e)},o.prototype.send=function(e){this._worker.postMessage({type:"message",data:e})},o.prototype.onMessage=function(e){this._messageHandler=e},o.prototype.onDisconnect=function(){},o.prototype.disconnect=function(){this._worker.terminate()}};t?(r(),u()):(s(),a());var f=function(){this._platformConnection=new o,this._importCallbacks={},this._executeSCb=function(){},this._executeFCb=function(){},this._messageHandler=function(){};var e=this;this.whenInit=function(t){e._platformConnection.whenInit(t)},this._platformConnection.onMessage(function(t){switch(t.type){case"message":e._messageHandler(t.data);break;case"importSuccess":e._handleImportSuccess(t.url);break;case"importFailure":e._handleImportFailure(t.url);break;case"executeSuccess":e._executeSCb();break;case"executeFailure":e._executeFCb()}})};f.prototype.importScript=function(e,t,n){var r=function(){};this._importCallbacks[e]={sCb:t||r,fCb:n||r},this._platformConnection.send({type:"import",url:e})},f.prototype.importJailedScript=function(e,t,n){var r=function(){};this._importCallbacks[e]={sCb:t||r,fCb:n||r},this._platformConnection.send({type:"importJailed",url:e})},f.prototype.execute=function(e,t,n){this._executeSCb=t||function(){},this._executeFCb=n||function(){},this._platformConnection.send({type:"execute",code:e})},f.prototype.onMessage=function(e){this._messageHandler=e},f.prototype.onDisconnect=function(e){this._platformConnection.onDisconnect(e)},f.prototype.send=function(e){this._platformConnection.send({type:"message",data:e})},f.prototype._handleImportSuccess=function(e){var t=this._importCallbacks[e].sCb;this._importCallbacks[e]=null,delete this._importCallbacks[e],t()},f.prototype._handleImportFailure=function(e){var t=this._importCallbacks[e].fCb;this._importCallbacks[e]=null,delete this._importCallbacks[e],t()},f.prototype.disconnect=function(){this._platformConnection.disconnect()};var l=function(e,t){this._path=e,this._initialInterface=t||{},this._connect()},c=function(e,t){this._code=e,this._initialInterface=t||{},this._connect()};c.prototype._connect=l.prototype._connect=function(){this.remote=null,this._connect=new n,this._fail=new n,this._disconnect=new n;var e=this;this._fCb=function(){e._fail.emit(),e.disconnect()},this._connection=new f,this._connection.whenInit(function(){e._init()})},c.prototype._init=l.prototype._init=function(){this._site=new JailedSite(this._connection);var e=this;this._site.onDisconnect(function(){e._disconnect.emit()});var t=function(){e._loadCore()};this._connection.importScript(__jailed__path__+"_JailedSite.js",t,this._fCb)},c.prototype._loadCore=l.prototype._loadCore=function(){var e=this,t=function(){e._sendInterface()};this._connection.importScript(__jailed__path__+"_pluginCore.js",t,this._fCb)},c.prototype._sendInterface=l.prototype._sendInterface=function(){var e=this;this._site.onInterfaceSetAsRemote(function(){e._connected||e._loadPlugin()}),this._site.setInterface(this._initialInterface)},l.prototype._loadPlugin=function(){var e=this,t=function(){e._requestRemote()};this._connection.importJailedScript(this._path,t,this._fCb)},c.prototype._loadPlugin=function(){var e=this,t=function(){e._requestRemote()};this._connection.execute(this._code,t,this._fCb)},c.prototype._requestRemote=l.prototype._requestRemote=function(){var e=this;this._site.onRemoteUpdate(function(){e.remote=e._site.getRemote(),e._connect.emit()}),this._site.requestRemote()},c.prototype.disconnect=l.prototype.disconnect=function(){this._connection.disconnect(),this._disconnect.emit()},c.prototype.whenFailed=l.prototype.whenFailed=function(e){this._fail.whenEmitted(e)},c.prototype.whenConnected=l.prototype.whenConnected=function(e){this._connect.whenEmitted(e)},c.prototype.whenDisconnected=l.prototype.whenDisconnected=function(e){this._disconnect.whenEmitted(e)},e.Plugin=l,e.DynamicPlugin=c});