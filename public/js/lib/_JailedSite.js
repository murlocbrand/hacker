(function(){JailedSite=function(t){this._interface={},this._remote=null,this._remoteUpdateHandler=function(){},this._getInterfaceHandler=function(){},this._interfaceSetAsRemoteHandler=function(){},this._disconnectHandler=function(){},this._store=new e;var n=this;this._connection=t,this._connection.onMessage(function(e){n._processMessage(e)}),this._connection.onDisconnect(function(e){n._disconnectHandler(e)})},JailedSite.prototype.onRemoteUpdate=function(e){this._remoteUpdateHandler=e},JailedSite.prototype.onInterfaceSetAsRemote=function(e){this._interfaceSetAsRemoteHandler=e},JailedSite.prototype.onGetInterface=function(e){this._getInterfaceHandler=e},JailedSite.prototype.getRemote=function(){return this._remote},JailedSite.prototype.setInterface=function(e){this._interface=e,this._sendInterface()},JailedSite.prototype._sendInterface=function(){var e=[];for(var t in this._interface)this._interface.hasOwnProperty(t)&&e.push(t);this._connection.send({type:"setInterface",api:e})},JailedSite.prototype._processMessage=function(e){switch(e.type){case"method":var t=this._interface[e.name],n=this._unwrap(e.args);t.apply(null,n);break;case"callback":var t=this._store.fetch(e.id)[e.num],n=this._unwrap(e.args);t.apply(null,n);break;case"setInterface":this._setRemote(e.api);break;case"getInterface":this._sendInterface(),this._getInterfaceHandler();break;case"interfaceSetAsRemote":this._interfaceSetAsRemoteHandler();break;case"disconnect":this._disconnectHandler()}},JailedSite.prototype.requestRemote=function(){this._connection.send({type:"getInterface"})},JailedSite.prototype._setRemote=function(e){this._remote={};var t,n;for(t=0;t<e.length;t++)n=e[t],this._remote[n]=this._genRemoteMethod(n);this._remoteUpdateHandler(),this._reportRemoteSet()},JailedSite.prototype._genRemoteMethod=function(e){var t=this,n=function(){t._connection.send({type:"method",name:e,args:t._wrap(arguments)})};return n},JailedSite.prototype._reportRemoteSet=function(){this._connection.send({type:"interfaceSetAsRemote"})},JailedSite.prototype._wrap=function(e){var t=[],n={},r=!1;for(var i=0;i<e.length;i++)typeof e[i]=="function"?(n[i]=e[i],t[i]={type:"callback",num:i},r=!0):t[i]={type:"argument",value:e[i]};var s={args:t};return r&&(s.callbackId=this._store.put(n)),s},JailedSite.prototype._unwrap=function(e){var t=!1,n=function(e){return function(){if(!!t){var n="A callback from this set has already been executed";throw new Error(n)}t=!0,e.apply(this,arguments)}},r=[],i,s,o,u=this;for(i=0;i<e.args.length;i++)s=e.args[i],s.type=="argument"?r.push(s.value):(o=n(this._genRemoteCallback(e.callbackId,i)),r.push(o));return r},JailedSite.prototype._genRemoteCallback=function(e,t){var n=this,r=function(){n._connection.send({type:"callback",id:e,num:t,args:n._wrap(arguments)})};return r},JailedSite.prototype.disconnect=function(){this._connection.send({type:"disconnect"}),this._connection.disconnect()},JailedSite.prototype.onDisconnect=function(e){this._disconnectHandler=e};var e=function(){this._store={},this._indices=[0]};e.prototype._genId=function(){var e;return this._indices.length==1?e=this._indices[0]++:e=this._indices.shift(),e},e.prototype._releaseId=function(e){for(var t=0;t<this._indices.length;t++)if(e<this._indices[t]){this._indices.splice(t,0,e);break}for(t=this._indices.length-1;t>=0;t--){if(this._indices[t]-1!=this._indices[t-1])break;this._indices.pop()}},e.prototype.put=function(e){var t=this._genId();return this._store[t]=e,t},e.prototype.fetch=function(e){var t=this._store[e];return this._store[e]=null,delete this._store[e],this._releaseId(e),t}})();